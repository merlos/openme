# Maintainer: Juan M. Merlos <merlos@users.noreply.github.com>
pkgname=openme
pkgver=0.1.0
pkgrel=1
pkgdesc="Single Packet Authorization server and client"
arch=('x86_64' 'aarch64' 'armv7h')
url="https://openme.merlos.org"
license=('MIT')
makedepends=('go')
optdepends=('iptables-nft: for automatic firewall rule management'
            'nftables: alternative firewall backend')
backup=('etc/openme/config.yaml')
source=("$pkgname-$pkgver.tar.gz::https://github.com/merlos/openme/archive/refs/tags/v$pkgver.tar.gz"
        "openme.service")
sha256sums=('SKIP'
            'SKIP')

# The service file is taken from the repository itself; the second source
# entry above is overridden by the one inside the tarball via prepare().
prepare() {
    # Use the bundled service file from the tarball so this PKGBUILD works
    # with a local checkout via `makepkg --nodeps` as well.
    cp "$srcdir/$pkgname-$pkgver/cli/packaging/systemd/openme.service" \
       "$srcdir/openme.service" 2>/dev/null || true
}

build() {
    cd "$srcdir/$pkgname-$pkgver/cli"
    export CGO_ENABLED=0
    export GOFLAGS="-buildmode=exe"
    go build \
        -ldflags "-s -w -X main.version=$pkgver" \
        -o openme \
        ./cmd/openme
}

check() {
    cd "$srcdir/$pkgname-$pkgver/cli"
    go test ./...
}

package() {
    cd "$srcdir/$pkgname-$pkgver"

    # Binary
    install -Dm755 cli/openme              "$pkgdir/usr/bin/openme"

    # systemd unit
    install -Dm644 cli/packaging/systemd/openme.service \
                                           "$pkgdir/usr/lib/systemd/system/openme.service"

    # Default config directory (config.yaml is generated by `openme init`)
    install -dm755                         "$pkgdir/etc/openme"

    # License
    install -Dm644 LICENSE                 "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

    # Documentation
    install -Dm644 README.md               "$pkgdir/usr/share/doc/$pkgname/README.md"
    install -Dm644 cli/README.md           "$pkgdir/usr/share/doc/$pkgname/cli/README.md"
}
